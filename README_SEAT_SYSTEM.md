# ğŸ« 12306 åŒºé—´åº§ä½ç®¡ç†ç³»ç»Ÿ

## âœ… å·²å®ç°åŠŸèƒ½

### æ ¸å¿ƒåŠŸèƒ½
1. âœ… **åŒºé—´åº§ä½å¤ç”¨** - åŒä¸€åº§ä½åœ¨ä¸é‡å åŒºé—´å¯è¢«å¤šä¸ªè®¢å•ä½¿ç”¨
2. âœ… **ç²¾ç¡®åº§ä½åˆ†é…** - ä¸ºæ¯ä¸ªä¹˜å®¢åˆ†é…å…·ä½“çš„è½¦å¢å·å’Œåº§ä½å·
3. âœ… **åŒºé—´å†²çªæ£€æµ‹** - é˜²æ­¢åŒä¸€åº§ä½åœ¨é‡å åŒºé—´è¢«é‡å¤é¢„è®¢
4. âœ… **åŒçŠ¶æ€åº§ä½é”å®š** - æœªæ”¯ä»˜(reserved)å’Œå·²æ”¯ä»˜(confirmed)åˆ†åˆ«é”å®š
5. âœ… **è®¢å•è¶…æ—¶é‡Šæ”¾** - 20åˆ†é’Ÿæœªæ”¯ä»˜è‡ªåŠ¨é‡Šæ”¾åº§ä½
6. âœ… **ä½™ç¥¨å®æ—¶è®¡ç®—** - åŸºäºåŒºé—´æŸ¥è¯¢å¯ç”¨åº§ä½æ•°é‡
7. âœ… **26ä¸ªè½¦æ¬¡æ•°æ®** - ä» è½¦æ¬¡ä¿¡æ¯.json å¯¼å…¥å®Œæ•´æ•°æ®
8. âœ… **108,276ä¸ªåº§ä½** - ä¸ºæœªæ¥3å¤©ç”Ÿæˆæ‰€æœ‰åº§ä½æ•°æ®

---

## ğŸ“Š æ•°æ®ç»Ÿè®¡

```
âœ… è½¦æ¬¡æ€»æ•°: 26 ä¸ª
âœ… åœé ç«™è®°å½•: 114 æ¡
âœ… è½¦å¢é…ç½®: 416 ä¸ª
âœ… ç­æ¬¡æ€»æ•°: 328 ä¸ªï¼ˆ3å¤©ï¼‰
âœ… åº§ä½æ€»æ•°: 108,276 ä¸ª
âœ… åº§ä½é”å®š: 0 ä¸ªï¼ˆå°šæ— è®¢å•ï¼‰

å¸­åˆ«åˆ†å¸ƒï¼š
  - å•†åŠ¡åº§: ~2,520 ä¸ª
  - ä¸€ç­‰åº§: ~10,752 ä¸ª
  - äºŒç­‰åº§: ~95,000 ä¸ª
```

---

## ğŸ—‚ï¸ æ–°å¢æ•°æ®åº“è¡¨

### 1. train_stopsï¼ˆè½¦æ¬¡åœé ç«™ï¼‰
è®°å½•æ¯ä¸ªè½¦æ¬¡çš„æ‰€æœ‰åœé ç«™åŠé¡ºåº

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| train_id | INTEGER | è½¦æ¬¡ID |
| station_id | INTEGER | ç«™ç‚¹ID |
| stop_sequence | INTEGER | åœé é¡ºåº(1,2,3...) |
| arrival_time | TEXT | åˆ°è¾¾æ—¶é—´ |
| departure_time | TEXT | å‡ºå‘æ—¶é—´ |

### 2. train_carsï¼ˆè½¦å¢é…ç½®ï¼‰
è®°å½•æ¯ä¸ªè½¦æ¬¡çš„è½¦å¢ç±»å‹å’Œåº§ä½æ•°

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| train_id | INTEGER | è½¦æ¬¡ID |
| car_number | INTEGER | è½¦å¢å· |
| car_type | TEXT | è½¦å¢ç±»å‹ |
| total_seats | INTEGER | æ€»åº§ä½æ•° |

### 3. schedule_seatsï¼ˆå…·ä½“åº§ä½ï¼‰
ğŸ”¥ **æ ¸å¿ƒè¡¨**ï¼šè®°å½•æŸå¤©æŸè½¦æ¬¡çš„æ¯ä¸ªå…·ä½“åº§ä½

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| schedule_id | INTEGER | ç­æ¬¡ID |
| car_number | INTEGER | è½¦å¢å· |
| seat_row | INTEGER | æ’å· |
| seat_column | TEXT | åˆ—å·(A-F) |
| seat_number | TEXT | å®Œæ•´åº§ä½å·(å¦‚"01A") |
| seat_type | TEXT | åº§ä½ç±»å‹ |
| price | REAL | å…¨ç¨‹ç¥¨ä»· |
| status | TEXT | available/reserved/sold |

### 4. seat_segmentsï¼ˆåº§ä½åŒºé—´é”å®šï¼‰
ğŸ”¥ **æ ¸å¿ƒè¡¨**ï¼šè®°å½•åº§ä½åœ¨å“ªäº›åŒºé—´è¢«é”å®š

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| seat_id | INTEGER | åº§ä½ID |
| order_id | INTEGER | è®¢å•ID |
| from_stop_seq | INTEGER | èµ·å§‹ç«™åºå· |
| to_stop_seq | INTEGER | ç»ˆç‚¹ç«™åºå· |
| status | TEXT | reserved/confirmed/cancelled |

---

## ğŸ¯ æ ¸å¿ƒç®—æ³•

### åŒºé—´å†²çªæ£€æµ‹
```sql
-- æ£€æŸ¥åº§ä½åœ¨ [from_seq, to_seq) åŒºé—´æ˜¯å¦å¯ç”¨
-- å¦‚æœå­˜åœ¨é”å®šåŒºé—´ [locked_from, locked_to)ï¼Œä½¿å¾—
-- locked_from < to_seq AND locked_to > from_seq
-- åˆ™ä¸¤ä¸ªåŒºé—´æœ‰äº¤é›†ï¼Œå­˜åœ¨å†²çª

SELECT COUNT(*) as conflicts
FROM seat_segments ss
WHERE ss.seat_id = ?
  AND ss.status IN ('reserved', 'confirmed')
  AND ss.from_stop_seq < ?    -- to_seq
  AND ss.to_stop_seq > ?;     -- from_seq
```

### åº§ä½åˆ†é…æµç¨‹
```
1. è§£æä¹˜å®¢éœ€æ±‚ï¼ˆå¸­åˆ«ã€æ•°é‡ï¼‰
2. è·å–èµ·æ­¢ç«™åºå·
3. æŸ¥è¯¢å¯ç”¨åº§ä½ï¼ˆæ’é™¤åŒºé—´å†²çªï¼‰
4. åˆ†é…åº§ä½ï¼ˆé¡ºåºåˆ†é…ï¼‰
5. åˆ›å»ºè®¢å•è®°å½•
6. é”å®šåº§ä½åŒºé—´ï¼ˆstatus='reserved'ï¼‰
7. è¿”å›åº§ä½ä¿¡æ¯ï¼ˆè½¦å¢å·ã€åº§ä½å·ï¼‰
```

---

## ğŸš€ å¦‚ä½•ä½¿ç”¨

### æ–¹å¼1ï¼šå‰ç«¯è‡ªåŠ¨ä½¿ç”¨ï¼ˆæ¨èï¼‰
å‰ç«¯æœç´¢å’Œè®¢å•APIå·²è‡ªåŠ¨é›†æˆV2ç‰ˆæœ¬ï¼š
```javascript
// æœç´¢è½¦æ¬¡æ—¶ï¼Œæ·»åŠ  useV2: true å‚æ•°
const response = await fetch('/api/trains/search', {
  method: 'POST',
  body: JSON.stringify({
    fromCity: 'åŒ—äº¬',
    toCity: 'ä¸Šæµ·',
    departureDate: '2026-01-20',
    useV2: true  // â† ä½¿ç”¨æ–°çš„åº§ä½ç³»ç»Ÿ
  })
});

// æäº¤è®¢å•æ—¶ï¼Œæ·»åŠ  useV2: true å‚æ•°
const response = await fetch('/api/orders/submit', {
  method: 'POST',
  body: JSON.stringify({
    trainNumber: 'G103',
    fromStation: 'åŒ—äº¬å—',
    toStation: 'ä¸Šæµ·è™¹æ¡¥',
    passengers: [...],
    useV2: true  // â† ä½¿ç”¨æ–°çš„åº§ä½ç³»ç»Ÿ
  })
});
```

### æ–¹å¼2ï¼šç›´æ¥è°ƒç”¨å‡½æ•°
```javascript
import { submitOrderV2 } from './database/submit_order_v2.js';
import { searchTrainsV2 } from './database/search_trains_v2.js';

// æœç´¢è½¦æ¬¡
const trains = await searchTrainsV2('åŒ—äº¬', 'ä¸Šæµ·', '2026-01-20');

// æäº¤è®¢å•
const order = await submitOrderV2(userId, {
  trainNumber: 'G103',
  departureDate: '2026-01-20',
  fromStation: 'åŒ—äº¬å—',
  toStation: 'ä¸Šæµ·è™¹æ¡¥',
  passengers: [...]
});
```

---

## ğŸ“ åº§ä½ç¼–å·è§„åˆ™

### åº§ä½è½¦å¢
- **å•†åŠ¡åº§**: 2+1å¸ƒå±€ï¼Œ01A-10Fï¼Œå…±30åº§
- **ä¸€ç­‰åº§**: 2+2å¸ƒå±€ï¼Œ01A-16Fï¼Œå…±64åº§
- **äºŒç­‰åº§**: 2+3å¸ƒå±€ï¼Œ01A-20Fï¼Œå…±100åº§

### å§é“ºè½¦å¢
- **è½¯å§**: 001A-036Dï¼Œ36ä¸ªé“ºä½
- **ç¡¬å§**: 001A-060Fï¼Œ60ä¸ªé“ºä½

---

## ğŸ”„ ç³»ç»Ÿç»´æŠ¤

### å®šæ—¶ä»»åŠ¡
```
1. è®¢å•æ¸…ç† - æ¯å¤©å‡Œæ™¨3ç‚¹
   - åˆ é™¤30å¤©å‰çš„è®¢å•

2. åº§ä½é”å®šæ¸…ç† - æ¯åˆ†é’Ÿ
   - é‡Šæ”¾è¶…æ—¶è®¢å•çš„åº§ä½é”å®š
```

### æ•°æ®æ¸…ç†
```bash
# æ¸…ç†æ—§çš„åº§ä½æ•°æ®ï¼ˆä¿ç•™æœ€è¿‘7å¤©ï¼‰
sqlite3 backend/database.db "
DELETE FROM seat_segments 
WHERE seat_id IN (
  SELECT ss.id 
  FROM schedule_seats ss
  JOIN train_schedules ts ON ss.schedule_id = ts.id
  WHERE ts.departure_date < date('now', '-7 days')
);

DELETE FROM schedule_seats 
WHERE schedule_id IN (
  SELECT id FROM train_schedules
  WHERE departure_date < date('now', '-7 days')
);
"
```

---

## ğŸ§ª æµ‹è¯•ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šåŒºé—´åº§ä½å¤ç”¨
```javascript
// è®¢å•A: åŒ—äº¬ â†’ æµå— (åŒºé—´ [1, 3])
{
  trainNumber: 'G103',
  fromStation: 'åŒ—äº¬å—',
  toStation: 'æµå—è¥¿',
  passengers: [{ name: 'å¼ ä¸‰', seatClass: 'äºŒç­‰åº§' }]
}
// ç»“æœ: 4è½¦01A

// è®¢å•B: æµå— â†’ ä¸Šæµ· (åŒºé—´ [3, 9])
{
  trainNumber: 'G103',
  fromStation: 'æµå—è¥¿',
  toStation: 'ä¸Šæµ·è™¹æ¡¥',
  passengers: [{ name: 'æå››', seatClass: 'äºŒç­‰åº§' }]
}
// ç»“æœ: 4è½¦01A â† åŒä¸€åº§ä½ï¼å› ä¸ºåŒºé—´ä¸é‡å 
```

### ç¤ºä¾‹2ï¼šåŒºé—´å†²çª
```javascript
// è®¢å•A: åŒ—äº¬ â†’ å—äº¬ (åŒºé—´ [1, 7])
// ç»“æœ: 4è½¦01A

// è®¢å•B: æµå— â†’ ä¸Šæµ· (åŒºé—´ [3, 9])
// å°è¯•ä½¿ç”¨ 4è½¦01A
// ç»“æœ: âŒ å¤±è´¥ï¼åŒºé—´ [3, 9] ä¸ [1, 7] æœ‰äº¤é›†
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `docs/DATABASE_REDESIGN_PROPOSAL.md` - å®Œæ•´è®¾è®¡æ–¹æ¡ˆ
- `docs/SEAT_SYSTEM_SETUP.md` - å¿«é€Ÿå¯åŠ¨æŒ‡å—
- `docs/ROUTING_VERIFICATION.md` - é¡µé¢è·³è½¬éªŒè¯

---

## ğŸ¯ ä¸‹ä¸€æ­¥æ”¹è¿›å»ºè®®

### P1 - åº”è¯¥å®ç°
1. âœ… åº§ä½å·æ˜¾ç¤ºæ ¼å¼åŒ–ï¼ˆå¦‚"4è½¦01Aåº§"ï¼‰
2. âœ… è®¢å•è¯¦æƒ…æ˜¾ç¤ºå®Œæ•´åº§ä½ä¿¡æ¯
3. âšª è¿å·åº§ä½ä¼˜å…ˆåˆ†é…ï¼ˆåŒè¡Œä¹˜å®¢åä¸€èµ·ï¼‰
4. âšª ä½™ç¥¨æ•°é‡ç¼“å­˜ï¼ˆRedisï¼‰

### P2 - å¯ä»¥å®ç°
1. âšª ç”¨æˆ·é€‰åº§åŠŸèƒ½
2. âšª åº§ä½åœ°å›¾å¯è§†åŒ–
3. âšª åˆ†æ®µç¥¨ä»·è®¡ç®—
4. âšª åº§ä½åå¥½è®¾ç½®ï¼ˆé çª—/é èµ°é“ï¼‰

---

**ğŸ‰ ç³»ç»Ÿå·²å®Œæˆæ ¸å¿ƒåŠŸèƒ½ï¼Œå¯æŠ•å…¥ä½¿ç”¨ï¼**

**æœ€åæ›´æ–°**ï¼š2026-01-19
